<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.caring.sass.nursing.dao.form.IndicatorsResultInformationMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.caring.sass.nursing.entity.form.IndicatorsResultInformation">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="create_user" jdbcType="BIGINT" property="createUser"/>
        <result column="update_user" jdbcType="BIGINT" property="updateUser"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
        <result column="patient_id" jdbcType="BIGINT" property="patientId"/>
        <result column="patient_name" jdbcType="BIGINT" property="patientName"/>
        <result column="doctor_id" jdbcType="BIGINT" property="doctorId"/>
        <result column="doctor_name" jdbcType="BIGINT" property="doctorName"/>
        <result column="handle_status" jdbcType="TINYINT" property="handleStatus"/>
        <result column="clear_status" jdbcType="TINYINT" property="clearStatus"/>
        <result column="handle_time" jdbcType="TIMESTAMP" property="handleTime"/>
        <result column="handle_user" jdbcType="BIGINT" property="handleUser"/>
        <result column="indicators_condition_id" jdbcType="BIGINT" property="indicatorsConditionId"/>
        <result column="plan_id" jdbcType="BIGINT" property="planId"/>
        <result column="nursing_id" jdbcType="BIGINT" property="nursingId"/>
        <result column="form_id" jdbcType="BIGINT" property="formId"/>
        <result column="field_id" jdbcType="VARCHAR" property="fieldId"/>
        <result column="field_label" jdbcType="VARCHAR" property="fieldLabel"/>
        <result column="real_write_value" jdbcType="VARCHAR" property="realWriteValue"/>
        <result column="form_write_time" jdbcType="TIMESTAMP" property="formWriteTime"/>
        <result column="max_condition_symbol" jdbcType="VARCHAR" property="maxConditionSymbol"/>
        <result column="max_condition_value" jdbcType="VARCHAR" property="maxConditionValue"/>
        <result column="min_condition_symbol" jdbcType="VARCHAR" property="minConditionSymbol"/>
        <result column="min_condition_value" jdbcType="VARCHAR" property="minConditionValue"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id,create_time,create_user,update_user,update_time,
        patient_id, patient_name, doctor_id, doctor_name, handle_status, clear_status, handle_time, handle_user, indicators_condition_id, plan_id, form_id, field_id, field_label, real_write_value, form_write_time, max_condition_symbol, max_condition_value, min_condition_symbol, min_condition_value
    </sql>


    <select id="getPatientCountByPlanIdNursingId" resultType= "java.lang.Integer">
        select count(1)
        from
        (
        select patient_id from t_nursing_indicators_result_information
        where (plan_id = #{planId}
        and nursing_id = #{nursingId}
        and handle_status = 1)
        group by patient_id
        ) t
    </select>

    <!-- 异常数据已处理列表自定义分页查询 -->
    <select id="selectdataProcessedPageList" parameterType="java.util.Map" resultType="com.caring.sass.nursing.vo.MonitorProcessedVo">
     SELECT * from (SELECT
     	patient_id AS patientId,
     	max( patient_name ) AS patientName,
     	max( avatar ) AS patientAvatar,
     	max( doctor_id ) AS doctorId,
     	max( doctor_name ) AS doctorName,
     	max( handle_time ) AS handleTime,
        max( form_write_time ) AS formWriteTime
     FROM
     	t_nursing_indicators_result_information
     WHERE
        clear_status = 1
        <if test=" handleStatus != null">
            AND handle_status = #{handleStatus}
        </if>
        <if test="dto != null and dto.nursingId != null">
            AND nursing_id = #{dto.nursingId}
        </if>
        <if test="dto != null and dto.planId != null ">
            AND plan_id = #{dto.planId}
        </if>
        <if test="dto != null and dto.patientName != null and dto.patientName.trim() != '' ">
            AND patient_name like concat(concat('%', #{dto.patientName}),'%')
        </if>
     GROUP BY
     	patient_id
     	) t
        <if test="dto != null and dto.sort ==1 and handleStatus ==2 ">
            ORDER BY t.handleTime desc
        </if>
        <if test="dto != null and dto.sort ==2  and handleStatus ==2 ">
            ORDER BY t.handleTime asc
        </if>
        <if test="dto != null and dto.sort ==1 and handleStatus ==1 ">
            ORDER BY t.formWriteTime desc
        </if>
        <if test="dto != null and dto.sort ==2  and handleStatus ==1 ">
            ORDER BY t.formWriteTime asc
        </if>

    </select>

    <!-- 异常数据已处理列表自定义分页查询 -->
    <select id="selectdataUnprocessedPageList"  resultType="com.caring.sass.nursing.vo.ValueAndTimeVo">
        SELECT
        real_write_value AS realWriteValue,
        real_write_value_right_unit AS company,
        form_write_time AS formWriteTime,
        field_label AS fieldLabel
        FROM
        t_nursing_indicators_result_information
        WHERE
        clear_status = 1
        <if test=" patientId != null">
            AND patient_id = #{patientId}
        </if>
        <if test=" handleStatus != null">
            AND handle_status = #{handleStatus}
        </if>
        <if test="dto != null and dto.nursingId != null">
            AND nursing_id = #{dto.nursingId}
        </if>
        <if test="dto != null and dto.planId != null ">
            AND plan_id = #{dto.planId}
        </if>
        ORDER BY form_write_time desc
    </select>

</mapper>
