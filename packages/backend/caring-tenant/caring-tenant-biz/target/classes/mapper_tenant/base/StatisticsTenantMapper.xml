<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.caring.sass.tenant.dao.StatisticsTenantMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.caring.sass.tenant.entity.StatisticsTenant">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="create_user" jdbcType="BIGINT" property="createUser"/>
        <result column="update_user" jdbcType="BIGINT" property="updateUser"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
        <result column="code" jdbcType="VARCHAR" property="code"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="logo" jdbcType="VARCHAR" property="logo"/>
        <result column="domain_name" jdbcType="VARCHAR" property="domainName"/>
        <result column="patient_num" jdbcType="INTEGER" property="patientNum"/>
        <result column="patient_register_num" jdbcType="INTEGER" property="patientRegisterNum"/>
        <result column="patient_no_register_num" jdbcType="INTEGER" property="patientNoRegisterNum"/>
        <result column="doctor_num" jdbcType="INTEGER" property="doctorNum"/>
        <result column="doctor_register_num" jdbcType="INTEGER" property="doctorRegisterNum"/>
        <result column="doctor_no_register_num" jdbcType="INTEGER" property="doctorNoRegisterNum"/>
        <result column="nursing_staff_num" jdbcType="INTEGER" property="nursingStaffNum"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id,create_time,create_user,update_user,update_time,
        code, name, logo, domain_name, patient_num, patient_register_num, patient_no_register_num, doctor_num, doctor_register_num, doctor_no_register_num, nursing_staff_num
    </sql>


    <!-- 查询项目统计信息 -->
    <select id="queryDb" resultMap="BaseResultMap">
        SELECT a.CODE, a.NAME, a.id, a.logo, a.domain_name
             , IFNULL(b.totalPatientNum, 0) AS "patient_num"
             , IFNULL(b.regPatientNum, 0) AS "patient_register_num"
             , IFNULL(b.unRegPatientNum, 0) AS "patient_no_register_num"
             , IFNULL(c.totalDoctorNum, 0) AS "doctor_num"
             , IFNULL(c.regDoctorNum, 0) AS "doctor_register_num"
             , IFNULL(c.unRegDoctorNum, 0) AS "doctor_no_register_num"
             , IFNULL(d.totalServiceNum, 0) AS "nursing_staff_num"
        FROM d_tenant a
                 LEFT JOIN (
            SELECT tenant_code AS "tenantCode", count(*) AS "totalPatientNum"
                 , sum(CASE
                           WHEN p.status_ = 1
                               OR p.status_ = 2
                               THEN 1
                           ELSE 0
                END) AS "regPatientNum"
                 , sum(CASE
                           WHEN p.status_ = 0
                               OR p.status_ = 3
                               THEN 1
                           ELSE 0
                END) AS "unRegPatientNum"
            FROM u_user_patient p
            GROUP BY tenant_code
        ) b
                           ON a.`code` = b.tenantCode
                 LEFT JOIN (
            SELECT tenant_code AS "tenantCode", count(*) AS "totalDoctorNum"
                 , sum(IF(d.last_login_time IS NULL, 0, 1)) AS "regDoctorNum"
                 , sum(IF(d.last_login_time IS NULL, 1, 0)) AS "unRegDoctorNum"
            FROM u_user_doctor d
            GROUP BY tenant_code
        ) c
                           ON c.tenantCode = a.`code`
                 LEFT JOIN (
            SELECT tenant_code, count(*) AS "totalServiceNum"
            FROM u_user_nursing_staff
            GROUP BY tenant_code
        ) d
                           ON d.tenant_code = a.`code`
    </select>



</mapper>
