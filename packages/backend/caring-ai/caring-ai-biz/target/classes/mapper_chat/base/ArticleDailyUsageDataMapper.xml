<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.caring.sass.ai.article.dao.ArticleDailyUsageDataMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.caring.sass.ai.entity.article.ArticleDailyUsageData">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="create_user" jdbcType="BIGINT" property="createUser"/>
        <result column="update_user" jdbcType="BIGINT" property="updateUser"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
        <result column="user_id" jdbcType="BIGINT" property="userId"/>
        <result column="week_number" jdbcType="INTEGER" property="weekNumber"/>
        <result column="register_number" jdbcType="BIGINT" property="registerNumber"/>
        <result column="active_number" jdbcType="BIGINT" property="activeNumber"/>
        <result column="produce_first_complete_user_number" jdbcType="BIGINT" property="produceFirstCompleteUserNumber"/>
        <result column="produce_complete_user_number" jdbcType="BIGINT" property="produceCompleteUserNumber"/>
        <result column="produce_start_user_number" jdbcType="BIGINT" property="produceStartUserNumber"/>
        <result column="produce_complete_total_number" jdbcType="BIGINT" property="produceCompleteTotalNumber"/>
        <result column="produce_error_total_number" jdbcType="BIGINT" property="produceErrorTotalNumber"/>
        <result column="produce_unfinished_total_number" jdbcType="BIGINT" property="produceUnfinishedTotalNumber"/>
        <result column="article_complete_number" jdbcType="BIGINT" property="articleCompleteNumber"/>
        <result column="podcast_complete_number" jdbcType="BIGINT" property="podcastCompleteNumber"/>
        <result column="video_complete_number" jdbcType="BIGINT" property="videoCompleteNumber"/>
        <result column="create_day" jdbcType="VARCHAR" property="createDay"/>
        <result column="create_month" jdbcType="VARCHAR" property="createMonth"/>
        <result column="day_7_active" jdbcType="INTEGER" property="day7Active"/>
        <result column="day_30_active" jdbcType="INTEGER" property="day30Active"/>
        <result column="article_original_science_number" jdbcType="BIGINT" property="articleOriginalScienceNumber"/>
        <result column="article_rewrite_science_number" jdbcType="BIGINT" property="articleRewriteScienceNumber"/>
        <result column="article_original_social_number" jdbcType="BIGINT" property="articleOriginalSocialNumber"/>
        <result column="article_rewrite_social_number" jdbcType="BIGINT" property="articleRewriteSocialNumber"/>
        <result column="article_original_video_number" jdbcType="BIGINT" property="articleOriginalVideoNumber"/>
        <result column="article_rewrite_video_number" jdbcType="BIGINT" property="articleRewriteVideoNumber"/>
        <result column="article_original_digital_person_number" jdbcType="BIGINT" property="articleOriginalDigitalPersonNumber"/>
        <result column="podcast_number" jdbcType="BIGINT" property="podcastNumber"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id,create_time,create_user,update_user,update_time,
        user_id, week_number, register_number, active_number, produce_first_complete_user_number,
        produce_complete_user_number, produce_start_user_number, produce_complete_total_number,
        produce_error_total_number, produce_unfinished_total_number, article_complete_number,
        podcast_complete_number, video_complete_number, create_day, create_month, day_7_active,
        day_30_active, article_rewrite_science_number, article_original_social_number, article_original_science_number,
        article_rewrite_social_number, article_original_video_number, article_rewrite_video_number,
        article_original_digital_person_number, podcast_number
    </sql>



    <select id="countActiveUsers" resultType="int">
        <![CDATA[
        SELECT COUNT(user_id)
        FROM (
            SELECT create_user AS user_id
            FROM m_ai_article_task
            WHERE task_status IN (1,2)
              AND create_time >= #{startTime}
              AND create_time <= #{endTime}

            UNION

            SELECT user_id
            FROM m_ai_podcast
            WHERE task_status = 'TASK_FINISH'
              AND create_time >= #{startTime}
              AND create_time <= #{endTime}

            UNION

            SELECT user_id
            FROM m_ai_article_user_voice_task
            WHERE task_status = 'SUCCESS'
              AND create_time >= #{startTime}
              AND create_time <= #{endTime}
        ) AS t
        ]]>
    </select>



    <select id="countAllProduceUserNumber" resultType="int">
        <![CDATA[
        SELECT COUNT(user_id)
        FROM (
            SELECT create_user AS user_id
            FROM m_ai_article_task
            WHERE
              create_time >= #{startTime}
              AND create_time <= #{endTime}

            UNION

            SELECT user_id
            FROM m_ai_podcast
            WHERE create_time >= #{startTime}
              AND create_time <= #{endTime}

            UNION

            SELECT user_id
            FROM m_ai_article_user_voice_task
            WHERE create_time >= #{startTime}
              AND create_time <= #{endTime}
        ) AS t
        ]]>
    </select>

    <select id="countAllProduce" resultType="int">
        <![CDATA[
        SELECT COUNT(*)
        FROM (
            SELECT id
            FROM m_ai_article_task
            WHERE
              create_time >= #{startTime}
              AND create_time <= #{endTime}

            UNION

            SELECT id
            FROM m_ai_podcast
            WHERE create_time >= #{startTime}
              AND create_time <= #{endTime}

            UNION

            SELECT id
            FROM m_ai_article_user_voice_task
            WHERE create_time >= #{startTime}
              AND create_time <= #{endTime}
        ) AS t
        ]]>
    </select>


    <select id="produceUnfinishedTotalNumber" resultType="int">
        <![CDATA[
        SELECT COUNT(*)
        FROM (
            SELECT id
            FROM m_ai_article_task
            WHERE step < 5
              AND create_time >= #{startTime}
              AND create_time <= #{endTime}

            UNION

            SELECT id
            FROM m_ai_podcast
            WHERE task_status not in ('CREATE_ERROR','CREATE_DIALOGUE_ERROR', 'TASK_FINISH')
              AND create_time >= #{startTime}
              AND create_time <= #{endTime}

            UNION

            SELECT id
            FROM m_ai_article_user_voice_task
            WHERE task_status not in ('FAIL', 'SUCCESS')
              AND create_time >= #{startTime}
              AND create_time <= #{endTime}
        ) AS t
        ]]>
    </select>




</mapper>
