<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.caring.sass.user.dao.StatisticsDoctorMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.caring.sass.user.entity.StatisticsDoctor">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="create_user" jdbcType="BIGINT" property="createUser"/>
        <result column="update_user" jdbcType="BIGINT" property="updateUser"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
        <result column="patient_num" jdbcType="INTEGER" property="patientNum"/>
        <result column="patient_register_num" jdbcType="INTEGER" property="patientRegisterNum"/>
        <result column="patient_no_register_num" jdbcType="INTEGER" property="patientNoRegisterNum"/>
        <result column="doctor_id" jdbcType="BIGINT" property="doctorId"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="avatar" jdbcType="VARCHAR" property="avatar"/>
        <result column="nursing_name" jdbcType="VARCHAR" property="nursingName"/>
        <result column="hospital_name" jdbcType="VARCHAR" property="hospitalName"/>
        <result column="organ_name" jdbcType="VARCHAR" property="organName"/>
        <result column="tenant_code" jdbcType="VARCHAR" property="tenantCode"/>
        <result column="doctor_status" jdbcType="TINYINT" property="doctorStatus"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id,create_time,create_user,update_user,update_time,
        patient_num, patient_register_num, patient_no_register_num, doctor_id, name, avatar, nursing_name, hospital_name, organ_name, tenant_code, doctor_status
    </sql>

    <select id="queryDb" resultMap="BaseResultMap">
        SELECT
            a.id AS 'doctor_id',
            a.NAME AS 'name',
            a.tenant_code As 'tenant_code',
            a.hospital_name AS 'hospital_name',
            a.organ_name AS 'organ_name',
            a.nursing_name AS 'nursing_name',
            a.avatar AS 'avatar',
            IF
                ( a.last_login_time IS NULL, '2', '1' ) AS 'doctor_status',
            IF(b.patient_num IS NULL, 0, b.patient_num) AS 'patient_num',
            IF(b.patient_register_num IS NULL, 0, b.patient_register_num) AS 'patient_register_num',
            IF(b.patient_no_register_num, 0, b.patient_no_register_num) AS 'patient_no_register_num'
        FROM
            u_user_doctor a
                LEFT JOIN (
                SELECT
                    doctor_id AS 'doctorId',
                    tenant_code AS 'tenantCode',
                    count(*) AS 'patient_num',
                    sum( CASE WHEN ( p.status_ = 1 OR p.status_ = 2 ) THEN 1 ELSE 0 END ) AS 'patient_register_num',
                    sum( CASE WHEN ( p.status_ = 0 OR p.status_ = 3 ) THEN 1 ELSE 0 END ) AS 'patient_no_register_num'
                FROM
                    u_user_patient p
                GROUP BY
                    p.tenant_code,
                    p.doctor_id
            ) b ON a.id = b.doctorId
    </select>


</mapper>
