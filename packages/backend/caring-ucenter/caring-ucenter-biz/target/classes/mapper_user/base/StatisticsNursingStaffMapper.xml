<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.caring.sass.user.dao.StatisticsNursingStaffMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.caring.sass.user.entity.StatisticsNursingStaff">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="create_user" jdbcType="BIGINT" property="createUser"/>
        <result column="update_user" jdbcType="BIGINT" property="updateUser"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
        <result column="patient_num" jdbcType="INTEGER" property="patientNum"/>
        <result column="patient_register_num" jdbcType="INTEGER" property="patientRegisterNum"/>
        <result column="patient_no_register_num" jdbcType="INTEGER" property="patientNoRegisterNum"/>
        <result column="nursing_staff_id" jdbcType="BIGINT" property="nursingStaffId"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="avatar" jdbcType="VARCHAR" property="avatar"/>
        <result column="organ_name" jdbcType="VARCHAR" property="organName"/>
        <result column="doctor_num" jdbcType="INTEGER" property="doctorNum"/>
        <result column="doctor_register_num" jdbcType="INTEGER" property="doctorRegisterNum"/>
        <result column="doctor_no_register_num" jdbcType="INTEGER" property="doctorNoRegisterNum"/>
        <result column="tenant_code" jdbcType="VARCHAR" property="tenantCode"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id,create_time,create_user,update_user,update_time,
        patient_num, patient_register_num, patient_no_register_num,
        nursing_staff_id, name, avatar, organ_name, doctor_num, doctor_register_num, doctor_no_register_num
    </sql>

    <select id="queryDb" resultMap="BaseResultMap">
        SELECT
            a.id AS 'nursing_staff_id',
            a.NAME as 'name',
            a.tenant_code,
            a.organ_name,
            a.avatar,
            IF(b.patient_num IS NUll , 0,b.patient_num) AS patient_num,
            IF(b.patient_register_num IS NULL, 0, b.patient_register_num) as patient_register_num,
            IF(b.patient_no_register_num IS NULL, 0, b.patient_no_register_num) as patient_no_register_num,
            IF(c.doctor_num IS NUll, 0, c.doctor_num) as doctor_num,
            IF(c.doctor_register_num IS NULL, 0, c.doctor_register_num) as doctor_register_num,
            IF(c.doctor_no_register_num IS NULL, 0, c.doctor_no_register_num) AS doctor_no_register_num
        FROM
            u_user_nursing_staff a
                LEFT JOIN (
                SELECT
                    service_advisor_id AS 'service_advisor_id',
                    tenant_code AS 'tenantCode',
                    count(*) AS 'patient_num',
                    sum( CASE WHEN ( p.status_ = 1 OR p.status_ = 2 ) THEN 1 ELSE 0 END ) AS 'patient_register_num',
                    sum( CASE WHEN ( p.status_ = 0 OR p.status_ = 3 ) THEN 1 ELSE 0 END ) AS 'patient_no_register_num'
                FROM
                    u_user_patient p
                GROUP BY
                    p.tenant_code,
                    p.service_advisor_id
            ) b ON a.id = b.service_advisor_id
                LEFT JOIN (
                SELECT
                    nursing_id AS 'nursingId',
                    tenant_code AS 'tenantCode',
                    count(*) AS 'doctor_num',
                    sum( IF ( d.last_login_time IS NULL, 0, 1 ) ) AS 'doctor_register_num',
                    sum( IF ( d.last_login_time IS NULL, 1, 0 ) ) AS 'doctor_no_register_num'
                FROM
                    u_user_doctor d
                GROUP BY
                    d.nursing_id,
                    d.tenant_code
            ) c ON a.id = c.nursingId
    </select>

</mapper>
